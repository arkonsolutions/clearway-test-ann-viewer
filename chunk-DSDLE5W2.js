import{$a as c,Aa as R,Ia as V,La as b,Ma as v,Na as j,O as d,Oa as F,Pa as p,Qa as a,Ra as l,Sa as P,T as x,Ta as w,U as M,Ua as u,Va as m,W as X,Wa as U,Xa as $,Ya as q,Za as I,_a as D,a as N,aa as g,b as O,bb as Q,ea as Y,fb as y,gb as W,hb as h,la as B,ma as k,na as s,ob as Z,pb as f,ua as _,wb as L,xb as C}from"./chunk-77374FZU.js";var nt=["editor"];function et(r,t){if(r&1){let n=w();a(0,"textarea",11,0),u("blur",function(){x(n);let o=m();return M(o.commitEdit())}),l()}}function ot(r,t){if(r&1&&(a(0,"div",4),c(1),l()),r&2){let n=m();s(),Q(" ",n.ann().text," ")}}function it(r,t){if(r&1){let n=w();a(0,"button",12),u("click",function(){x(n);let o=m();return M(o.enableEdit())}),c(1,"\u270E"),l()}}function rt(r,t){if(r&1){let n=w();a(0,"button",13),u("click",function(){x(n);let o=m();return M(o.commitEdit())}),c(1,"\u2713"),l()}}var A=class r{editorRef;injector=d(X);ann=h.required();store=d(C);host=d(Y);editing=g(!1);hoverBox=g(!1);hoverControls=g(!1);showControls=y(()=>this.hoverBox()||this.hoverControls());styleBox=y(()=>({left:`${this.ann().x*100}%`,top:`${this.ann().y*100}%`,width:`${this.ann().w*100}%`,height:`${this.ann().h*100}%`}));dragPointerId=null;resizePointerId=null;captureEl=null;layerEl=null;dragStartPos=null;resizeStartPos=null;constructor(){W(()=>{this.store.targetAnnotationId()===this.ann().id&&(this.enableEdit(),this.store.clearTargetAnnotation())})}onDocPointerDown(t){this.host.nativeElement.contains(t.target)||(this.hoverBox.set(!1),this.hoverControls.set(!1))}onBoxEnter(){this.hoverBox.set(!0)}onBoxLeave(){this.hoverBox.set(!1)}onCtrlsEnter(){this.hoverControls.set(!0)}onCtrlsLeave(){this.hoverControls.set(!1)}onDragStart(t){if(t.preventDefault(),t.pointerType==="mouse"&&t.button!==0)return;let n=t.currentTarget;n.setPointerCapture(t.pointerId),this.captureEl=n,this.dragPointerId=t.pointerId,this.dragStartPos={x:t.clientX,y:t.clientY}}onResizeStart(t){if(t.preventDefault(),t.pointerType==="mouse"&&t.button!==0)return;let n=t.currentTarget;n.setPointerCapture(t.pointerId),this.captureEl=n,this.resizePointerId=t.pointerId;let e=this.ann();this.resizeStartPos={startX:t.clientX,startY:t.clientY,baseW:e.w,baseH:e.h}}onPointerMove(t){if(this.layerEl||(this.layerEl=this.host.nativeElement.closest(".ann-layer")),!this.layerEl)return;let n=this.layerEl.getBoundingClientRect();if(this.resizeStartPos){if(t.pointerType==="mouse"&&(t.buttons&1)===0)return;let e=(t.clientX-this.resizeStartPos.startX)/n.width,o=(t.clientY-this.resizeStartPos.startY)/n.height,i=this.ann(),S=L(this.resizeStartPos.baseW+e,.02,1-i.x),E=L(this.resizeStartPos.baseH+o,.02,1-i.y);this.store.updateAnnotation(i.id,{w:S,h:E});return}if(this.dragStartPos){if(t.pointerType==="mouse"&&(t.buttons&1)===0)return;let e=(t.clientX-this.dragStartPos.x)/n.width,o=(t.clientY-this.dragStartPos.y)/n.height,i=this.ann();this.store.updateAnnotation(i.id,{x:Math.max(0,Math.min(1-i.w,i.x+e)),y:Math.max(0,Math.min(1-i.h,i.y+o))}),this.dragStartPos={x:t.clientX,y:t.clientY}}}releasePointerCapture(){let t=this.resizePointerId??this.dragPointerId;this.captureEl&&t!=null&&this.captureEl.hasPointerCapture(t)&&this.captureEl.releasePointerCapture(t),this.captureEl=null,this.dragPointerId=null,this.resizePointerId=null}onPointerUp(){this.releasePointerCapture(),this.dragStartPos=null,this.resizeStartPos=null}onPointerCancel(){this.releasePointerCapture(),this.dragStartPos=null,this.resizeStartPos=null}onLostPointerCapture(){this.releasePointerCapture(),this.dragStartPos=null,this.resizeStartPos=null}delete(){this.store.deleteAnnotation(this.ann().id)}enableEdit(){this.editing.set(!0),R(()=>{let t=this.editorRef?.nativeElement;if(t!=null){t.textContent=this.ann().text,t.focus();let n=t.value.length;t.setSelectionRange(n,n)}},{injector:this.injector})}commitEdit(){this.editorRef&&this.store.updateAnnotation(this.ann().id,{text:this.editorRef.nativeElement.value}),this.editing.set(!1)}static \u0275fac=function(n){return new(n||r)};static \u0275cmp=_({type:r,selectors:[["app-annotation-item"]],viewQuery:function(n,e){if(n&1&&U(nt,5),n&2){let o;$(o=q())&&(e.editorRef=o.first)}},hostBindings:function(n,e){n&1&&u("pointerdown",function(i){return e.onDocPointerDown(i)},k)("pointermove",function(i){return e.onPointerMove(i)})("pointerup",function(){return e.onPointerUp()})("pointercancel",function(){return e.onPointerCancel()})("lostpointercapture",function(){return e.onLostPointerCapture()})},inputs:{ann:[1,"ann"]},decls:13,vars:7,consts:[["editor",""],[1,"annotation",3,"mouseenter","mouseleave","ngStyle"],[1,"annotation__content"],[1,"annotation__editor"],[1,"annotation__text"],[1,"annotation__controls",3,"mouseenter","mouseleave"],["title","\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C",1,"annotation__handle","annotation__handle--move",3,"pointerdown"],["title","\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",1,"annotation__handle","annotation__handle--edit"],["title","\u041F\u0440\u0438\u043C\u0435\u043D\u0438\u0442\u044C",1,"annotation__handle","annotation__handle--commit"],["title","\u0423\u0434\u0430\u043B\u0438\u0442\u044C",1,"annotation__handle","annotation__handle--delete",3,"click"],["title","\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0440\u0430\u0437\u043C\u0435\u0440",1,"annotation__handle","annotation__resize",3,"pointerdown"],[1,"annotation__editor",3,"blur"],["title","\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",1,"annotation__handle","annotation__handle--edit",3,"click"],["title","\u041F\u0440\u0438\u043C\u0435\u043D\u0438\u0442\u044C",1,"annotation__handle","annotation__handle--commit",3,"click"]],template:function(n,e){n&1&&(a(0,"div",1),u("mouseenter",function(){return e.onBoxEnter()})("mouseleave",function(){return e.onBoxLeave()}),a(1,"div",2),b(2,et,2,0,"textarea",3)(3,ot,2,1,"div",4),l(),a(4,"div",5),u("mouseenter",function(){return e.onCtrlsEnter()})("mouseleave",function(){return e.onCtrlsLeave()}),a(5,"button",6),u("pointerdown",function(i){return e.onDragStart(i)}),c(6,"\u2725"),l(),b(7,it,2,0,"button",7)(8,rt,2,0,"button",8),a(9,"button",9),u("click",function(){return e.delete()}),c(10,"\u2715"),l()(),a(11,"button",10),u("pointerdown",function(i){return e.onResizeStart(i)}),c(12,"\u2921"),l()()),n&2&&(p("ngStyle",e.styleBox()),s(2),v(e.editing()?2:3),s(2),D("annotation__controls--visible",e.showControls()),s(3),v(e.editing()?8:7),s(4),D("annotation__resize--visible",e.showControls()))},dependencies:[f,Z],styles:[".annotation[_ngcontent-%COMP%]{position:absolute;border:2px solid #4b9cff;background:#4b9cff1f;border-radius:.25rem;box-sizing:border-box;z-index:1}.annotation__content[_ngcontent-%COMP%]{position:absolute;inset:0;padding:.25rem;overflow:hidden}.annotation__text[_ngcontent-%COMP%]{font-size:.85rem;color:#103b6d;line-height:1.2;white-space:pre-line}.annotation__editor[_ngcontent-%COMP%]{width:100%;height:100%;resize:none;border:none;outline:none;font:inherit;background:transparent;color:#103b6d}.annotation__controls[_ngcontent-%COMP%]{position:absolute;left:50%;bottom:100%;transform:translate(-50%);z-index:2;padding:6px 8px 10px;background:#fff;border:1px solid #d0d0d0;border-radius:.5rem;box-shadow:0 2px 8px #0000001f;display:inline-flex;align-items:center;gap:.25rem;opacity:0;pointer-events:none;transition:opacity .12s ease-out}.annotation__controls--visible[_ngcontent-%COMP%]{opacity:1;pointer-events:auto}.annotation__handle[_ngcontent-%COMP%]{border:1px solid #d0d0d0;background:#fff;border-radius:.375rem;padding:.2rem .35rem;cursor:grab;box-shadow:0 1px 2px #00000014}.annotation__handle--edit[_ngcontent-%COMP%], .annotation__handle--commit[_ngcontent-%COMP%], .annotation__handle--delete[_ngcontent-%COMP%]{cursor:pointer}.annotation__handle--move[_ngcontent-%COMP%]{cursor:grab}.annotation__handle--commit[_ngcontent-%COMP%]{color:green}.annotation__resize[_ngcontent-%COMP%]{position:absolute;right:0;bottom:0;padding:.2rem .35rem;cursor:se-resize;opacity:0;pointer-events:none;transition:opacity .12s ease-out}.annotation__resize--visible[_ngcontent-%COMP%]{opacity:1;pointer-events:auto}"]})};var at=(r,t)=>t.id;function st(r,t){if(r&1&&P(0,"app-annotation-item",1),r&2){let n=t.$implicit;p("ann",n),V("data-ann-id",n.id)}}function lt(r,t){if(r&1&&P(0,"div",3),r&2){let n=m();I("left",n.Math.min(n.dragging().startX,n.dragging().curX)*100,"%")("top",n.Math.min(n.dragging().startY,n.dragging().curY)*100,"%")("width",n.Math.abs(n.dragging().curX-n.dragging().startX)*100,"%")("height",n.Math.abs(n.dragging().curY-n.dragging().startY)*100,"%")}}var T=class r{Math=Math;page=h.required();store=d(C);anns=this.store.annotations;dragging=g({active:!1,startX:0,startY:0,curX:0,curY:0});addDragPointerId=null;captureLayerEl=null;onPointerDown(t){if(t.pointerType==="mouse"&&t.button!==0){t.preventDefault();return}if(t.target.closest(".annotation"))return;let n=t.currentTarget.getBoundingClientRect(),e=(t.clientX-n.left)/n.width,o=(t.clientY-n.top)/n.height;this.dragging.set({active:!0,startX:e,startY:o,curX:e,curY:o}),this.captureLayerEl=t.currentTarget,this.captureLayerEl.setPointerCapture(t.pointerId),this.addDragPointerId=t.pointerId}onPointerMove(t){if(!this.dragging().active)return;let n=t.currentTarget.getBoundingClientRect(),e=(t.clientX-n.left)/n.width,o=(t.clientY-n.top)/n.height;this.dragging.update(i=>O(N({},i),{curX:e,curY:o}))}onPointerUp(){if(!this.dragging().active)return;let{startX:t,startY:n,curX:e,curY:o}=this.dragging();this.dragging.set({active:!1,startX:0,startY:0,curX:0,curY:0});let i=Math.min(t,e),S=Math.min(n,o),E=Math.abs(e-t),z=Math.abs(o-n);if(this.captureLayerEl&&this.addDragPointerId&&this.captureLayerEl.hasPointerCapture(this.addDragPointerId)&&this.captureLayerEl.releasePointerCapture(this.addDragPointerId),this.captureLayerEl=null,this.addDragPointerId=null,E<.01&&z<.01)return;let H=this.store.addAnnotation({pageNumber:this.page().number,x:i,y:S,w:E,h:z,text:""});H&&this.store.setTargetAnnotation(H)}annsOnPage=y(()=>this.anns().filter(t=>t.pageNumber===this.page().number));static \u0275fac=function(n){return new(n||r)};static \u0275cmp=_({type:r,selectors:[["app-annotation-layer"]],inputs:{page:[1,"page"]},decls:4,vars:1,consts:[[1,"ann-layer",3,"pointerdown","pointermove","pointerup"],[3,"ann"],[1,"annotation","annotation--draft",3,"left","top","width","height"],[1,"annotation","annotation--draft"]],template:function(n,e){n&1&&(a(0,"div",0),u("pointerdown",function(i){return e.onPointerDown(i)})("pointermove",function(i){return e.onPointerMove(i)})("pointerup",function(){return e.onPointerUp()}),j(1,st,1,2,"app-annotation-item",1,at),b(3,lt,1,8,"div",2),l()),n&2&&(s(),F(e.annsOnPage()),s(2),v(e.dragging().active?3:-1))},dependencies:[f,A],styles:[".ann-layer[_ngcontent-%COMP%]{position:absolute;inset:0;touch-action:none}.annotation--draft[_ngcontent-%COMP%]{position:absolute;border:1.5px dashed #4b9cff;background:#4b9cff14;border-radius:.25rem}"]})};var tt=class r{page=h.required();store=d(C);zoom=this.store.zoom;static \u0275fac=function(n){return new(n||r)};static \u0275cmp=_({type:r,selectors:[["app-page"]],inputs:{page:[1,"page"]},decls:4,vars:4,consts:[[1,"page","page--ready"],[1,"page__surface"],[1,"page__img",3,"src"],[3,"page"]],template:function(n,e){n&1&&(a(0,"div",0)(1,"div",1),P(2,"img",2)(3,"app-annotation-layer",3),l()()),n&2&&(s(),I("width",e.zoom()*100,"%"),s(),p("src",e.page().imageUrl,B),s(),p("page",e.page()))},dependencies:[f,T],styles:[".page--ready[_ngcontent-%COMP%]{width:min(100%,1000px);display:grid;justify-items:center}.page__surface[_ngcontent-%COMP%]{position:relative;background:#fff;border-radius:.5rem;box-shadow:0 1px 4px #00000014;width:100%}.page__img[_ngcontent-%COMP%]{display:block;width:100%;height:auto;background:#fff}"]})};export{tt as PageComponent};
